<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>رفع منتجات بقالة السفير</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 50px; background: #f4f4f4; }
        .upload-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 400px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #2e7d32; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:hover { background: #1a531b; }
        #status { margin-top: 15px; text-align: center; font-size: 14px; }
    </style>
</head>
<body>

<div class="upload-card">
    <h3>إضافة منتج جديد</h3>
    <input type="text" id="pName" placeholder="اسم المنتج">
    <input type="number" id="pPrice" placeholder="السعر">
    <input type="file" id="pImage" accept="image/*">
    <button onclick="uploadProduct()">رفع المنتج الآن</button>
    <div id="status"></div>
</div>

<script>
    // بيانات مشروعك (جلبها من إعدادات Supabase)
    const SB_URL = 'https://YOUR_PROJECT_URL.supabase.co';
    const SB_KEY = 'YOUR_ANON_KEY';
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    async function uploadProduct() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        const file = document.getElementById('pImage').files[0];
        const status = document.getElementById('status');

        if (!name || !price || !file) {
            status.innerHTML = "❌ يرجى ملء كافة البيانات";
            return;
        }

        status.innerHTML = "⏳ جاري الرفع...";

        try {
            // 1. رفع الصورة إلى Bucket 'market'
            // نستخدم اسم فريد لتجنب تكرار الأسماء
            const fileName = `${Date.now()}_${file.name}`;
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('market')
                .upload(fileName, file);

            if (uploadError) throw uploadError;

            // 2. الحصول على الرابط العام (Public URL)
            const { data: urlData } = supabase.storage
                .from('market')
                .getPublicUrl(fileName);

            const imageUrl = urlData.publicUrl;

            // 3. (اختياري) حفظ البيانات في جدول المنتجات
            // تأكد من وجود جدول باسم products يحتوي على أعمدة (name, price, image_url)
            const { error: dbError } = await supabase
                .from('products')
                .insert([{ name, price, image_url: imageUrl }]);

            if (dbError) throw dbError;

            status.innerHTML = `✅ تم الرفع بنجاح! <br><a href="${imageUrl}" target="_blank">عرض الصورة</a>`;
            
            // تصغير الحقول بعد النجاح
            document.getElementById('pName').value = '';
            document.getElementById('pPrice').value = '';
            document.getElementById('pImage').value = '';

        } catch (err) {
            console.error(err);
            status.innerHTML = "❌ خطأ: " + err.message;
        }
    }
</script>

</body>
</html>
